<div class="settings-container">
    <h2>Settings</h2>
    <div class="settings-content">
        <div class="section livefeed-section">
            <h3>Live Feed Settings</h3>
            <p class="section-description">
                Configure how much prior audio you want to hear when enabling live feed. System and talkgroup delays are always respected and cannot be overridden.
            </p>
            
            <div class="backlog-setting">
                <mat-form-field appearance="outline" class="backlog-field">
                    <mat-label>Backlog (minutes)</mat-label>
                    <input 
                        matInput 
                        type="number" 
                        [(ngModel)]="livefeedBacklogMinutes"
                        (ngModelChange)="onBacklogChange()"
                        min="0" 
                        placeholder="0">
                    <mat-hint align="start">
                        <span *ngIf="livefeedBacklogMinutes === 0" class="hint-text">
                            No backlog - you'll only hear new calls going forward (live audio only).
                        </span>
                        <span *ngIf="livefeedBacklogMinutes > 0" class="hint-text">
                            You'll hear calls from the last {{ livefeedBacklogMinutes }} minute(s) when enabling live feed. System and talkgroup delays are always respected - if you have delays configured, the backlog is measured from the start of your delay period.
                        </span>
                    </mat-hint>
                </mat-form-field>
            </div>

            <div class="auto-livefeed-setting">
                <div class="setting-header">
                    <mat-slide-toggle 
                        [(ngModel)]="autoLivefeed"
                        (ngModelChange)="onAutoLivefeedChange()"
                        color="primary">
                        Auto Live Feed
                    </mat-slide-toggle>
                </div>
                <p class="setting-hint">
                    Automatically start live feed when the app opens.
                </p>
                <p class="pwa-disclaimer" *ngIf="!isPWA">
                    <mat-icon class="info-icon">info</mat-icon>
                    <span>This feature only works when the app is installed as a Progressive Web App (PWA). To install, use your browser's "Add to Home Screen" or "Install App" option.</span>
                </p>
                <p class="pwa-disclaimer active" *ngIf="isPWA">
                    <mat-icon class="info-icon">check_circle</mat-icon>
                    <span>App is installed as PWA - Auto Live Feed is available!</span>
                </p>
            </div>

            <div class="alert-sound-setting">
                <h4>Alert Notification Sound</h4>
                <p class="setting-description">
                    Choose a sound to play when new alerts arrive.
                </p>
                
                <div class="sound-selector">
                    <mat-form-field appearance="outline" class="sound-field">
                        <mat-label>Alert Sound</mat-label>
                        <mat-select 
                            [(ngModel)]="alertSound"
                            (selectionChange)="onAlertSoundChange(); previewAlertSound(alertSound)">
                            <mat-option *ngFor="let sound of availableAlertSounds" [value]="sound.name">
                                {{ sound.displayName }}
                            </mat-option>
                        </mat-select>
                        <mat-hint>Sound will play locally in your browser when new alerts arrive</mat-hint>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <div class="section display-section">
            <h3>Display Settings</h3>
            <p class="section-description">
                Customize the appearance of the app.
            </p>
            
            <div class="font-setting">
                <h4>App Font</h4>
                <p class="setting-description">
                    Choose a font for the entire app interface.
                </p>
                
                <div class="font-selector">
                    <mat-form-field appearance="outline" class="font-field">
                        <mat-label>Font</mat-label>
                        <mat-select 
                            [(ngModel)]="appFont"
                            (selectionChange)="onFontChange()">
                            <mat-option *ngFor="let font of availableFonts" [value]="font.name">
                                <span [style.font-family]="font.value">{{ font.displayName }}</span>
                            </mat-option>
                        </mat-select>
                        <mat-hint>Changes apply immediately to all text in the app</mat-hint>
                    </mat-form-field>
                </div>
            </div>
        </div>

        <div class="section tag-colors-section">
            <h3>Tag Colors</h3>
            <p class="section-description">
                Customize colors for tags. Tags are automatically populated from the scanner configuration.
            </p>
            
            <div *ngIf="availableTags.length === 0" class="empty-state">
                <mat-icon>palette</mat-icon>
                <p>No tags available yet. Tags will appear here once the scanner configuration is loaded.</p>
            </div>
            
            <div *ngIf="availableTags.length > 0" class="tag-colors-header">
                <button 
                    mat-button 
                    class="expand-toggle-button"
                    (click)="toggleTagsExpanded()">
                    <mat-icon>{{ tagsExpanded ? 'expand_less' : 'expand_more' }}</mat-icon>
                    <span>{{ tagsExpanded ? 'Collapse' : 'Expand' }} All Tags ({{ availableTags.length }})</span>
                </button>
            </div>
            
            <div *ngIf="availableTags.length > 0" class="tag-colors-list" [class.collapsed]="!tagsExpanded">
                <div *ngFor="let tag of availableTags" class="tag-color-item">
                    <div class="tag-info">
                        <span class="tag-name">{{ tag }}</span>
                        <button 
                            mat-icon-button 
                            class="reset-button"
                            (click)="resetTagColor(tag)"
                            matTooltip="Reset to default color">
                            <mat-icon>refresh</mat-icon>
                        </button>
                    </div>
                    <div class="color-input-container">
                        <mat-form-field appearance="outline" class="color-select-field">
                            <mat-label class="color-label">Color</mat-label>
                            <mat-select 
                                [value]="getSelectedColorValue(tag)"
                                (selectionChange)="setTagColor(tag, $event.value)"
                                [id]="getColorFieldId(tag)">
                                <mat-select-trigger>
                                    <div class="selected-color-display">
                                        <span class="color-swatch-circle" [style.background-color]="getSelectedColorValue(tag)"></span>
                                        <span class="selected-color-name">{{ getSelectedColorName(tag) }}</span>
                                    </div>
                                </mat-select-trigger>
                                <mat-option *ngFor="let color of availableColors" [value]="color.value">
                                    <div class="color-option">
                                        <span class="color-swatch-circle" [style.background-color]="color.value"></span>
                                        <span>{{ color.name }}</span>
                                    </div>
                                </mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
            </div>
            
            <div *ngIf="availableTags.length > 0" class="actions">
                <button 
                    mat-button 
                    class="reset-all-button"
                    (click)="resetAllColors()">
                    <mat-icon>restore</mat-icon>
                    Reset All Colors
                </button>
            </div>
        </div>
        
        <div class="section account-section">
            <h3>Account Information</h3>
            <p class="section-description">
                Manage your account details and security settings.
            </p>

            <div *ngIf="loadingAccount" class="loading-state">
                <mat-spinner diameter="24"></mat-spinner>
                <span>Loading account information...</span>
            </div>

            <div *ngIf="!loadingAccount && accountInfo" class="account-info">
                <div class="info-row">
                    <span class="info-label">Email:</span>
                    <span class="info-value">{{ accountInfo.email }}</span>
                </div>
                <div class="info-row" *ngIf="accountInfo.firstName || accountInfo.lastName">
                    <span class="info-label">Name:</span>
                    <span class="info-value">{{ accountInfo.firstName }} {{ accountInfo.lastName }}</span>
                </div>
                <div class="info-row" *ngIf="accountInfo.userGroupName">
                    <span class="info-label">Group:</span>
                    <span class="info-value">
                        {{ accountInfo.userGroupName }}
                        <span *ngIf="accountInfo.isGroupAdmin" class="group-admin-badge">(Admin)</span>
                    </span>
                </div>
                <div class="info-row" *ngIf="accountInfo.createdAt && accountInfo.createdAt > 0">
                    <span class="info-label">Member Since:</span>
                    <span class="info-value">{{ accountInfo.createdAt * 1000 | date:'mediumDate' }}</span>
                </div>
                <div class="info-row" *ngIf="accountInfo.lastLogin && accountInfo.lastLogin > 0">
                    <span class="info-label">Last Login:</span>
                    <span class="info-value">{{ accountInfo.lastLogin * 1000 | date:'medium' }}</span>
                </div>
            </div>
        </div>

        <div class="section email-section">
            <h3>Change Email</h3>
            <p class="section-description">
                To change your email address, you must first verify your current email. After changing your email, you'll need to verify the new email address to complete the change.
            </p>

            <!-- Step 1: Request and verify current email -->
            <div *ngIf="!emailChangeVerified" class="verification-step">
                <h4>Step 1: Verify Your Current Email</h4>
                <p class="step-description">
                    We'll send a verification code to your current email address: <strong>{{ accountInfo?.email }}</strong>
                </p>

                <div class="verification-actions">
                    <button 
                        mat-raised-button 
                        color="primary"
                        (click)="requestEmailChangeVerification()"
                        [disabled]="requestingVerification">
                        <mat-spinner *ngIf="requestingVerification" diameter="20" class="inline-spinner"></mat-spinner>
                        <span *ngIf="!requestingVerification">Send Verification Code</span>
                        <span *ngIf="requestingVerification">Sending...</span>
                    </button>
                </div>

                <form [formGroup]="emailVerificationForm" (ngSubmit)="verifyEmailChangeCode()" class="account-form" *ngIf="verificationCodeSent || emailVerificationForm.value.code">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Verification Code</mat-label>
                        <input matInput type="text" formControlName="code" placeholder="000000" maxlength="6" required>
                        <mat-hint>Enter the 6-digit code sent to your email</mat-hint>
                        <mat-error *ngIf="emailVerificationForm.get('code')?.hasError('required')">
                            Verification code is required
                        </mat-error>
                        <mat-error *ngIf="emailVerificationForm.get('code')?.hasError('pattern')">
                            Please enter a valid 6-digit code
                        </mat-error>
                    </mat-form-field>

                    <div class="form-actions">
                        <button 
                            mat-raised-button 
                            color="primary" 
                            type="submit"
                            [disabled]="emailVerificationForm.invalid || verifyingCode">
                            <mat-spinner *ngIf="verifyingCode" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!verifyingCode">Verify Code</span>
                            <span *ngIf="verifyingCode">Verifying...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Change email (only shown after verification) -->
            <div *ngIf="emailChangeVerified" class="email-change-step">
                <div class="verification-success">
                    <mat-icon>check_circle</mat-icon>
                    <span>Current email verified. You can now change your email address.</span>
                </div>

                <h4>Step 2: Enter New Email Address</h4>
                <form [formGroup]="emailForm" (ngSubmit)="updateEmail()" class="account-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>New Email</mat-label>
                        <input matInput type="email" formControlName="newEmail" required>
                        <mat-error *ngIf="emailForm.get('newEmail')?.hasError('required')">
                            Email is required
                        </mat-error>
                        <mat-error *ngIf="emailForm.get('newEmail')?.hasError('email')">
                            Please enter a valid email address
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Current Password</mat-label>
                        <input matInput type="password" formControlName="password" required>
                        <mat-error *ngIf="emailForm.get('password')?.hasError('required')">
                            Password is required
                        </mat-error>
                    </mat-form-field>

                    <div class="form-actions">
                        <button 
                            mat-button
                            type="button"
                            (click)="emailChangeVerified = false; emailVerificationForm.reset(); emailForm.reset()">
                            Cancel
                        </button>
                        <button 
                            mat-raised-button 
                            color="primary" 
                            type="submit"
                            [disabled]="emailForm.invalid || updatingEmail">
                            <mat-spinner *ngIf="updatingEmail" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!updatingEmail">Change Email</span>
                            <span *ngIf="updatingEmail">Changing...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="section password-section">
            <h3>Change Password</h3>
            <p class="section-description">
                To change your password, you must first verify your email address. This adds an extra layer of security to protect your account.
            </p>

            <!-- Step 1: Request and verify email -->
            <div *ngIf="!passwordChangeVerified" class="verification-step">
                <h4>Step 1: Verify Your Email</h4>
                <p class="step-description">
                    We'll send a verification code to your email address: <strong>{{ accountInfo?.email }}</strong>
                </p>

                <div class="verification-actions">
                    <button 
                        mat-raised-button 
                        color="primary"
                        (click)="requestPasswordChangeVerification()"
                        [disabled]="requestingPasswordVerification">
                        <mat-spinner *ngIf="requestingPasswordVerification" diameter="20" class="inline-spinner"></mat-spinner>
                        <span *ngIf="!requestingPasswordVerification">Send Verification Code</span>
                        <span *ngIf="requestingPasswordVerification">Sending...</span>
                    </button>
                </div>

                <form [formGroup]="passwordVerificationForm" (ngSubmit)="verifyPasswordChangeCode()" class="account-form" *ngIf="passwordVerificationCodeSent || passwordVerificationForm.value.code">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Verification Code</mat-label>
                        <input matInput type="text" formControlName="code" placeholder="000000" maxlength="6" required>
                        <mat-hint>Enter the 6-digit code sent to your email</mat-hint>
                        <mat-error *ngIf="passwordVerificationForm.get('code')?.hasError('required')">
                            Verification code is required
                        </mat-error>
                        <mat-error *ngIf="passwordVerificationForm.get('code')?.hasError('pattern')">
                            Please enter a valid 6-digit code
                        </mat-error>
                    </mat-form-field>

                    <div class="form-actions">
                        <button 
                            mat-raised-button 
                            color="primary" 
                            type="submit"
                            [disabled]="passwordVerificationForm.invalid || verifyingPasswordCode">
                            <mat-spinner *ngIf="verifyingPasswordCode" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!verifyingPasswordCode">Verify Code</span>
                            <span *ngIf="verifyingPasswordCode">Verifying...</span>
                        </button>
                    </div>
                </form>
            </div>

            <!-- Step 2: Change password (only shown after verification) -->
            <div *ngIf="passwordChangeVerified" class="password-change-step">
                <div class="verification-success">
                    <mat-icon>check_circle</mat-icon>
                    <span>Email verified. You can now change your password.</span>
                </div>

                <h4>Step 2: Enter New Password</h4>
                <form [formGroup]="passwordForm" (ngSubmit)="updatePassword()" class="account-form">
                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Current Password</mat-label>
                        <input matInput type="password" formControlName="currentPassword" required>
                        <mat-error *ngIf="passwordForm.get('currentPassword')?.hasError('required')">
                            Current password is required
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>New Password</mat-label>
                        <input matInput type="password" formControlName="newPassword" required>
                        <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('required')">
                            New password is required
                        </mat-error>
                        <mat-error *ngIf="passwordForm.get('newPassword')?.hasError('minlength')">
                            Password must be at least 6 characters
                        </mat-error>
                    </mat-form-field>

                    <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Confirm New Password</mat-label>
                        <input matInput type="password" formControlName="confirmPassword" required>
                        <mat-error *ngIf="passwordForm.get('confirmPassword')?.hasError('required')">
                            Please confirm your new password
                        </mat-error>
                        <mat-error *ngIf="passwordForm.hasError('passwordMismatch')">
                            Passwords do not match
                        </mat-error>
                    </mat-form-field>

                    <div class="form-actions">
                        <button 
                            mat-button
                            type="button"
                            (click)="passwordChangeVerified = false; passwordVerificationForm.reset(); passwordForm.reset()">
                            Cancel
                        </button>
                        <button 
                            mat-raised-button 
                            color="primary" 
                            type="submit"
                            [disabled]="passwordForm.invalid || updatingPassword">
                            <mat-spinner *ngIf="updatingPassword" diameter="20" class="inline-spinner"></mat-spinner>
                            <span *ngIf="!updatingPassword">Change Password</span>
                            <span *ngIf="updatingPassword">Changing...</span>
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <div class="section billing-section" *ngIf="accountInfo?.billingRequired || accountInfo?.hasBilling">
            <h3>Billing</h3>
            <p class="section-description">
                Manage your payment methods and subscription.
            </p>

            <div class="billing-info">
                <div class="info-row">
                    <span class="info-label">Subscription Status:</span>
                    <span class="info-value" [class.status-active]="accountInfo.subscriptionStatus === 'active'">
                        {{ getSubscriptionStatusDisplay() }}
                    </span>
                </div>
            </div>

            <div class="billing-actions">
                <button 
                    *ngIf="(accountInfo.subscriptionStatus === 'active' || accountInfo.subscriptionStatus === 'trialing') && accountInfo.stripeSubscriptionId"
                    mat-raised-button 
                    color="primary"
                    (click)="openBillingPortal()">
                    <mat-icon>payment</mat-icon>
                    Manage Payment or Cancel
                </button>
                <button 
                    *ngIf="(accountInfo.subscriptionStatus === 'active' || accountInfo.subscriptionStatus === 'trialing') && accountInfo.stripeSubscriptionId"
                    mat-raised-button 
                    color="accent"
                    (click)="openChangeSubscription()">
                    <mat-icon>swap_horiz</mat-icon>
                    Change Plan
                </button>
                <button 
                    *ngIf="(!accountInfo.stripeSubscriptionId || (accountInfo.subscriptionStatus !== 'active' && accountInfo.subscriptionStatus !== 'trialing')) && accountInfo.billingRequired && !isGroupAdminManaged()"
                    mat-raised-button 
                    color="primary"
                    (click)="openCheckout()">
                    <mat-icon>add_card</mat-icon>
                    Subscribe
                </button>
                <div *ngIf="isGroupAdminManaged()" class="admin-managed-message">
                    <p>Billing is managed by your group administrator. Please contact them if you need assistance.</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Stripe Checkout Modal -->
    <div class="checkout-overlay" *ngIf="showCheckout">
        <div class="checkout-backdrop" (click)="onCheckoutCancel()"></div>
        <div class="checkout-modal">
            <rdio-scanner-stripe-checkout
                *ngIf="config"
                [config]="config"
                [email]="userEmail"
                [isChangingPlan]="showChangeSubscription"
                [currentPriceId]="currentPriceId"
                (checkoutSuccess)="onCheckoutSuccess($event)"
                (checkoutError)="onCheckoutError($event)"
                (checkoutCancel)="onCheckoutCancel()">
            </rdio-scanner-stripe-checkout>
        </div>
    </div>
</div>

